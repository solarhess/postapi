<!DOCTYPE html>
<html>
    <head>
        <title>API</title>
    </head>
    <body>
        <h1>Sample API</h1>

        <h2>OAuth</h2>
        <a href="#" id="authorizeToken">Authorize With Token!</a>
        <a href="#" id="authorizeCode">Authorize With Code!</a>
        <a href="#" id="finishAuth">Finish Auth!</a>

        <h2>Data</h2>
        <a href="#" id="doit">Do It!</a>
        <div id="result">
            (no results)
        </div>
        <div id="api-frame"> </div>

        
        
        <script type="text/javascript" charset="utf-8" src="js/jquery-1.7.1.min.js">  </script>
        <script type="text/javascript" charset="utf-8" src="js/jquery-ui-1.8.16.custom.min.js">  </script>
        <script type="text/javascript" charset="utf-8" src="js/api.js">  </script>
        <script type="text/javascript" charset="utf-8">
            $(function() {
                var unparam = function (value) {
                    var
                    // Object that holds names => values.
                    params = {},
                    // Get query string pieces (separated by &)
                    pieces = value.split('&'),
                    // Temporary variables used in loop.
                    pair, i, l;

                    // Loop through query string pieces and assign params.
                    for (i = 0, l = pieces.length; i < l; i++) {
                        pair = pieces[i].split('=', 2);
                        // Repeated parameters with the same name are overwritten. Parameters
                        // with no value get set to boolean true.
                        params[decodeURIComponent(pair[0])] = (pair.length == 2 ?
                            decodeURIComponent(pair[1].replace(/\+/g, ' ')) : true);
                    }

                    return params;
                };
                
                function _tokenHashParam() {
                    return unparam(window.location.hash.slice(1)).access_token;
                }
                function _codeParam() {
                    return unparam(window.location.search.slice(1)).code;
                }
                function _redirectUri() {
                    var uri = window.location.href;
                    var indexOfHash = uri.indexOf('#');
                    var indexOfSearch = uri.indexOf('?');
                    if(indexOfHash >= 0 && indexOfSearch >= 0) {
                        uri = uri.substring(0, Math.min(indexOfHash, indexOfSearch));
                    } else if (indexOfHash >= 0 || indexOfSearch >= 0){
                        uri = uri.substring(0, Math.max(indexOfHash, indexOfSearch));
                    } else {
                        // uri = uri
                    }
                    
                    return uri;
                }
                
                var $apiFrame = $("#api-frame").postapi({
                    url: "http://example2.com:8080/concord/webservice/rest/",
                    apiUrl: "http://example2.com:8080/concord/js/other/postapi/api.html",
                    oauthAuthorizationUrl : "http://example2.com:8080/concord/oauth/authorize.sp",
        			oauthTokenUrl : "http://example2.com:8080/concord/oauth/token.sp",
        			oauthClientId : "my-trusted-client",
        			oauthToken : _tokenHashParam(),
        			oauthCode : _codeParam(),
        			oauthRedirectUri : _redirectUri()
        		});
        		
                $("#doit").click(function(evt) {
                    evt.preventDefault();
                    var ajaxOpts = {
        				dataType: "json",
        				contentType: "application/json",
                        url: "preferences/user",
                        success: function(data) {
                            console.log("SUCCESS  data: "+JSON.stringify(data));
                        },
                        error: function(jqxhr, data) {
                            console.log("ERROR jqxhr:"+JSON.stringify(jqxhr)+ "  data:"+JSON.stringify(data));
                        },
                        complete: function(jqxhr, data) {
                            console.log("COMPLETE jqxhr:"+JSON.stringify(jqxhr)+ "  data:"+JSON.stringify(data));
                        }
                    }
                    // $.ajax(ajaxOpts);
                    $apiFrame.postapi("sendRequest", ajaxOpts);
                });
                
                $("#authorizeToken").click(function(evt) {
                    $apiFrame.postapi("authorizeWithToken");
                });

                $("#authorizeCode").click(function(evt) {
                    $apiFrame.postapi("authorizeWithCode");
                });

                $("#finishAuth").click(function(evt) {
                    $apiFrame.postapi("finishAuthorization");
                });
            })
        </script>
    </body>
</html>